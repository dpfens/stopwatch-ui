<div id="{{ getInstance().id }}" class="stopwatch-list-item" [class.selected]="isSelected()"
    [class.selection-mode]="selectionMode() || hasAnySelection()" [class.running]="controller().isRunning()"
    [class.paused]="controller().isActive() && !controller().isRunning()" [class.inactive]="!controller().isActive()"
    (click)="onCardClick($event)">

    <!-- Selection Checkbox -->
    <div class="selection-checkbox-container" (click)="onSelectionChange($event)"
        [class.visible]="selectionMode() || hasAnySelection()">
        <mat-icon role="checkbox" [attr.aria-checked]="isSelected()" aria-label="Select stopwatch" tabindex="0"
            (keydown.enter)="onSelectionChange($event)" (keydown.space)="onSelectionChange($event)"
            class="selection-icon">
            @if(isSelected()) {
            check_circle
            } @else {
            radio_button_unchecked
            }
        </mat-icon>
    </div>

    <!-- Main Content Container -->
    <div class="list-item-content">
        @if(!displaySettings()) {
        <!-- Compact Header Row -->
        <div class="header-row d-flex justify-content-between gap-3 py-2">
            <!-- Title and Status Section -->
            <div class="title-section min-w-0 mb-1">
                <h5 class="stopwatch-title text-truncate mb-0">
                    {{ getInstance().annotation.title || 'Untitled' }}
                </h5>
                @if(getInstance().annotation.description) {
                <p class="description text-muted small mb-0 text-truncate">{{ getInstance().annotation.description }}
                </p>
                }
            </div>
            <!-- Compact Duration Display Section -->
            <div class="duration-section d-flex flex-column ">
                <div class="duration-display primary mb-1">
                    <div>
                        <div class="duration-label text-uppercase"
                            style="font-size: 10px; line-height: 1;">total</div>
                        <simple-timer [getDuration]="totalDurationCalc" [isRunning]="controller().isRunning()"
                            [includeMs]="totalDurationCalc() < MILLISECOND_THRESHOLD"
                            class="duration-time fw-bold"
                            style="font-size: 20px; line-height: 1.2;"></simple-timer>
                    </div>
                </div>

                @if(!!hasSplits() || !!hasLaps()) {
                <div class="secondary-durations d-flex justify-content-evenly gap-3">
                    @if(hasLaps()) {
                    <div class="duration-display secondary">
                        <div class="d-flex flex-column">
                            <span class="duration-label text-uppercase"
                                style="font-size: 9px; line-height: 1;">lap</span>
                            <simple-timer [getDuration]="lapDurationCalc" [isRunning]="controller().isRunning()"
                                [includeMs]="lapDurationCalc() < MILLISECOND_THRESHOLD"
                                class="duration-time"
                                style="font-size: 14px; line-height: 1.1;"></simple-timer>
                        </div>
                    </div>
                    }
                    @if(hasSplits()) {
                    <div class="duration-display secondary">
                        <div class="d-flex flex-column">
                            <span class="duration-label text-uppercase"
                                style="font-size: 9px; line-height: 1;">split</span>
                            <simple-timer [getDuration]="splitDurationCalc" [isRunning]="controller().isRunning()"
                                [includeMs]="splitDurationCalc() < MILLISECOND_THRESHOLD"
                                class="duration-time"
                                style="font-size: 14px; line-height: 1.1;"></simple-timer>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>


            <!-- Compact Controls Section -->
            <div class="controls-section">
                <!-- Compact Menu -->
                <div class="menu-section">
                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Stopwatch options"
                        class="menu-button btn-sm p-1"
                        [class.disabled-in-selection]="selectionMode() || hasAnySelection()">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu" xPosition="before">
                        <button mat-menu-item (click)="fork()">
                            <mat-icon>fork_right</mat-icon>
                            <span>Fork</span>
                        </button>
                        <button mat-menu-item (click)="showSettings()">
                            <mat-icon>settings</mat-icon>
                            <span>Settings</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="delete()" class="delete-item">
                            <mat-icon>delete</mat-icon>
                            <span>Delete</span>
                        </button>
                    </mat-menu>
                </div>
            </div>
        </div>

        <div class="text-center">
            <mat-button-toggle-group class="my-3 control-buttons" name="favoriteColor" aria-label="Favorite Color"
                [hideSingleSelectionIndicator]="true"
                [class.disabled-in-selection]="selectionMode() || hasAnySelection()">
                @if(showBasicControls()) {
                @if(!controller().isActive()) {
                <mat-button-toggle (click)="start()">
                    <mat-icon>play_arrow</mat-icon>
                    Start
                </mat-button-toggle>
                }
                @if(controller().isActive() && !controller().isRunning()) {
                <mat-button-toggle (click)="resume()">
                    <mat-icon>play_circle_outline</mat-icon>
                    Resume
                </mat-button-toggle>
                <mat-button-toggle (click)="reset()">
                    <mat-icon>restart_alt</mat-icon>
                    Reset
                </mat-button-toggle>
                }
                }
                @if(controller().isRunning()) {
                @if (showBasicControls()) {
                <mat-button-toggle (click)="stop()">
                    <mat-icon>stop</mat-icon>
                    Stop
                </mat-button-toggle>
                }
                @if(showCheckpointControls()) {
                @if (!!getInstance().state.lap) {
                <mat-button-toggle (click)="lap()">
                    <mat-icon>track_changes</mat-icon>
                    Lap
                </mat-button-toggle>
                }
                <mat-button-toggle (click)="split()">
                    <mat-icon>call_split</mat-icon>
                    Split
                </mat-button-toggle>
                }
                }
            </mat-button-toggle-group>
        </div>

        <!-- Compact Expandable Content -->
        <div class="expandable-content">
            @if(visibleSplits().length) {
            <div class="splits-section py-2 border-top">
                <div class="splits-header d-flex align-items-center justify-content-between">
                    <button mat-button class="toggle-splits-btn p-1 fw-medium small" (click)="toggleSplitsVisible()"
                        [attr.aria-label]="splitsVisible() ? 'Hide splits' : 'Show splits'">
                        <mat-icon>{{ splitsVisible() ? 'expand_less' : 'expand_more' }}</mat-icon>
                        {{ visibleSplits().length }} Split{{ visibleSplits().length !== 1 ? 's' : '' }}
                    </button>
                    @if(!splitsVisible() && visibleSplits().length > 0) {
                    <span class="splits-preview small">
                        Last: <span class="fw-medium">{{
                            timeService.msDurationFormatter().format(visibleSplits()[visibleSplits().length - 1].duration)
                            }}</span>
                    </span>
                    }
                </div>

                @if(splitsVisible()) {
                <div class="splits-container mt-2">
                    @for(split of visibleSplits(); track $index) {
                    <split-expansion-panel [instance]="split" (updateEmitter)="handleSplitUpdate($event)"
                        (deleteEmitter)="handleSplitDelete($event)"
                        [class.disabled-in-selection]="selectionMode() || hasAnySelection()" class="list-split mb-1">
                    </split-expansion-panel>
                    }
                </div>
                }
            </div>
            }
        </div>

        <!-- Groups - More compact -->
        @if(getInstance().groups.length) {
        <div>
            <div class="d-flex flex-column">
                <span class="section-label fw-medium small text-uppercase">Groups</span>
                <mat-chip-set aria-label="Groups" class="inline-chips">
                    @for(group of getInstance().groups; track group.id) {
                    <mat-chip class="small" routerLink="/group/{{ group.id }}">{{ group.annotation.title || truncate(group.id, 10) }}</mat-chip>
                    }
                </mat-chip-set>
            </div>
        </div>
        }
        } @else {
        <!-- Settings View -->
        <div class="settings-view">
            <div class="settings-header d-flex align-items-center justify-content-between py-2 border-bottom">
                <h4 class="fw-semibold mb-0">Stopwatch Settings</h4>
                <div class="settings-actions d-flex gap-2">
                    <button mat-button color="primary" (click)="saveAndClose()" class="btn-sm">
                        <mat-icon>save</mat-icon>
                        Save & Close
                    </button>
                    <button mat-button (click)="discardChanges()" class="btn-sm">
                        <mat-icon>close</mat-icon>
                        Cancel
                    </button>
                </div>
            </div>

            <form [formGroup]="settingsForm" class="settings-form py-3">
                <!-- Basic Info -->
                <div class="form-section mb-4">
                    <h5 class="fw-medium mb-3">Basic Information</h5>
                    <div class="form-grid row g-3">
                        <div class="col-md-6">
                            <mat-form-field class="field-title w-100">
                                <mat-label>Title</mat-label>
                                <input matInput placeholder="Ex. Pizza Timer" formControlName="title">
                                @if(getFieldError('title')) {
                                <mat-error>{{ getFieldError('title') }}</mat-error>
                                }
                            </mat-form-field>
                        </div>

                        <div class="col-md-6">
                            <mat-form-field class="field-description w-100">
                                <mat-label>Description</mat-label>
                                <input matInput placeholder="Optional description" formControlName="description">
                                @if(getFieldError('description')) {
                                <mat-error>{{ getFieldError('description') }}</mat-error>
                                }
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Lap Settings -->
                <div class="form-section mb-4">
                    <h5 class="fw-medium mb-3">Lap Configuration</h5>
                    <div class="form-grid row g-3">
                        <div class="col-md-4">
                            <mat-form-field class="field-lap-value w-100">
                                <mat-label>Lap Distance</mat-label>
                                <input type="number" matInput placeholder="400" formControlName="lapValue" min="0.01"
                                    step="0.01">
                                @if(getFieldError('lapValue')) {
                                <mat-error>{{ getFieldError('lapValue') }}</mat-error>
                                }
                            </mat-form-field>
                        </div>

                        <div class="col-md-4">
                            <mat-form-field class="field-lap-unit w-100">
                                <mat-label>Lap Units</mat-label>
                                <mat-select formControlName="lapUnit">
                                    @for (group of lapUnits; track group) {
                                    <mat-optgroup [label]="group.display">
                                        @for(option of group.options; track option.value) {
                                        <mat-option [value]="option.value">{{option.display}}</mat-option>
                                        }
                                    </mat-optgroup>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        @if(groups().length > 0) {
                        <div class="col-md-4">
                            <mat-form-field class="field-groups w-100">
                                <mat-label>Groups</mat-label>
                                <mat-select formControlName="groups" multiple>
                                    @for (group of groups(); track group.id) {
                                    <mat-option [value]="group.id">{{ group.annotation.title || group.id }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        }
                    </div>
                </div>

                <!-- Metadata -->
                <div class="form-section">
                    <h5 class="fw-medium mb-3">Information</h5>
                    <div class="metadata-grid row g-3">
                        <div class="col-md-6">
                            <div class="metadata-item">
                                <span class="metadata-label fw-medium small">Created:</span>
                                <time [dateTime]="getInstance().metadata.creation.timestamp.toISOString()"
                                    class="d-block fw-normal">
                                    {{ getInstance().metadata.creation.timestamp.format() }}
                                </time>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metadata-item">
                                <span class="metadata-label fw-medium small">Last Modified:</span>
                                <time [dateTime]="getInstance().metadata.lastModification.timestamp.toISOString()"
                                    class="d-block fw-normal">
                                    {{ getInstance().metadata.lastModification.timestamp.format() }}
                                </time>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        }
    </div>
</div>